<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Law Firm Daily Intake Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f7f7fb;
      --panel: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --accent: #1f6feb;
      --accent-2: #0ea5e9;
      --danger: #dc2626;
      --success: #16a34a;
      --warning: #d97706;
      --border: #e5e7eb;
      --radius: 10px;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg); color: var(--text);
    }
    header {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: white; padding: 24px 16px;
    }
    header .inner { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; gap: 16px; }
    header h1 { margin: 0; font-size: 22px; }
    header .firm {
      display: flex; gap: 8px; align-items: center;
      background: rgba(255,255,255,0.15); padding: 8px 12px; border-radius: 8px;
    }
    header input, header select {
      border: none; outline: none; background: transparent; color: #fff; border-bottom: 1px dashed rgba(255,255,255,0.6);
    }
    .container { max-width: 1200px; margin: 20px auto; padding: 0 16px 48px; display: grid; grid-template-columns: 1fr; gap: 20px; }
    @media (min-width: 1080px) {
      .container { grid-template-columns: 1.1fr 1.2fr; }
      /* Make Today's Intakes span full width between New Intake and End-of-Day Summary */
      #intakesSection { grid-column: 1 / -1; }
    }
    section {
      background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    section h2 { margin: 0 0 12px; font-size: 18px; }
    .row { display: grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 720px) {
      .row.cols-2 { grid-template-columns: 1fr 1fr; }
      .row.cols-3 { grid-template-columns: 1fr 1fr 1fr; }
      .row.cols-4 { grid-template-columns: 1fr 1fr 1fr 1fr; }
    }
    label { font-size: 13px; color: var(--muted); display: block; margin-bottom: 4px; }
    input[type="text"], input[type="email"], input[type="tel"], input[type="date"], input[type="number"], select, textarea {
      width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: #fff; color: var(--text);
    }
    textarea { min-height: 80px; resize: vertical; }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    button, .btn {
      appearance: none; border: none; background: var(--accent); color: #fff; padding: 10px 14px; border-radius: 8px; cursor: pointer; font-weight: 600;
      box-shadow: 0 1px 0 rgba(0,0,0,0.06);
    }
    button.secondary, .btn.secondary { background: #f3f4f6; color: #111827; border: 1px solid var(--border); }
    button.danger { background: var(--danger); }
    button.success { background: var(--success); }
    button.warning { background: var(--warning); }
    .muted { color: var(--muted); font-size: 12px; }
    .table-wrap { overflow: auto; border: 1px solid var(--border); border-radius: 8px; }
    table { border-collapse: collapse; width: 100%; min-width: 900px; }
    th, td { padding: 10px; border-bottom: 1px solid var(--border); text-align: left; vertical-align: top; font-size: 14px; }
    th { background: #f8fafc; position: sticky; top: 0; z-index: 1; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; font-weight: 600; }
    .pill.status-new { background: #e5f0ff; color: #1f6feb; }
    .pill.status-review { background: #fff3cd; color: #92400e; }
    .pill.status-retained { background: #dcfce7; color: #166534; }
    .pill.status-declined { background: #fee2e2; color: #991b1b; }
    .pill.status-conflict { background: #ffe4e6; color: #9f1239; }
    .pill.urgency-high { background: #fee2e2; color: #b91c1c; }
    .pill.urgency-medium { background: #fff7ed; color: #b45309; }
    .pill.urgency-low { background: #ecfeff; color: #0e7490; }
    .totals { display: flex; flex-wrap: wrap; gap: 10px; margin: 8px 0; }
    .totals .card {
      background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 8px 10px; font-size: 13px; color: #111827;
    }
    details { background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 8px 10px; }
    details summary { cursor: pointer; font-weight: 600; }
    .badge { font-size: 12px; background: #eef2ff; color: #4338ca; padding: 2px 6px; border-radius: 8px; }
    .grid { display: grid; gap: 10px; grid-template-columns: 1fr; }
    @media (min-width: 720px) { .grid.cols-2 { grid-template-columns: 1fr 1fr; } }
    .recipient { display: flex; align-items: center; gap: 8px; padding: 8px; border: 1px solid var(--border); border-radius: 8px; background: #fff; }
    .footer { text-align: center; color: var(--muted); font-size: 12px; padding: 20px 0 60px; }
    .hr { height: 1px; background: var(--border); margin: 10px 0; }
    .token-input { width: 100%; max-width: 280px; }
    .notice { background: #fffbeb; border: 1px solid #fde68a; color: #92400e; padding: 8px 10px; border-radius: 8px; font-size: 13px; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; background: #111827; color: #fff; padding: 2px 6px; border-radius: 6px; font-size: 12px; }
    .codeblock { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; white-space: pre; background: #0b1021; color: #e5e7eb; padding: 10px; border-radius: 8px; overflow: auto; font-size: 12px; line-height: 1.4; }
    .inline-help { font-size: 12px; color: var(--muted); }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }
    .soft { color: var(--muted); }
    .right { text-align: right; }
    .flex { display: flex; gap: 8px; align-items: center; }
    .spacer { flex: 1; }
    .sm { font-size: 12px; }
    .mb-8 { margin-bottom: 8px; }
    .mb-12 { margin-bottom: 12px; }
    .mb-4 { margin-bottom: 4px; }
    .mt-8 { margin-top: 8px; }
    .mt-12 { margin-top: 12px; }
    .mt-16 { margin-top: 16px; }
    .w-100 { width: 100%; }
    .align-end { align-items: end; }
    .nowrap { white-space: nowrap; }
    .hidden { display: none; }

    /* Print summary only */
    @media print {
      body { background: #fff; }
      header, #entryFormSection, #intakesSection .actions, #emailSection .actions, #emailSection #recipientsEditor, #emailSection .notice, #emailSection details, .footer { display: none !important; }
      #summaryPreview { display: block !important; }
      section { border: none; box-shadow: none; }
    }
  </style>
</head>
<body>
  <header>
    <div class="inner">
      <h1>Daily Intake Tracker</h1>
      <div class="firm">
        <span>Firm:</span>
        <input id="firmName" type="text" placeholder="Firm Name" />
        <span class="sr-only">Timezone</span>
        <select id="timezoneSelect" title="Reporting Timezone">
          <!-- Populated by JS -->
        </select>
      </div>
      <div class="firm">
        <span>Reply-To:</span>
        <input id="replyToEmail" type="email" placeholder="reply@firm.com" />
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Intake Entry Form -->
    <section id="entryFormSection" aria-labelledby="entryFormTitle">
      <h2 id="entryFormTitle">New Intake</h2>
      <form id="intakeForm">
        <div class="row cols-4">
          <div>
            <label for="intakeDate">Date</label>
            <input type="date" id="intakeDate" required />
          </div>
          <div>
            <label for="clientName">Client Name</label>
            <input type="text" id="clientName" placeholder="Jane Doe" required />
          </div>
          <div>
            <label for="clientEmail">Email</label>
            <input type="email" id="clientEmail" placeholder="jane@example.com" />
          </div>
          <div>
            <label for="clientPhone">Phone</label>
            <input type="tel" id="clientPhone" placeholder="(555) 555-5555" />
          </div>
        </div>

        <div class="row cols-4">
          <div>
            <label for="practiceArea">Practice Area</label>
            <select id="practiceArea">
              <option value="">Select...</option>
              <option>Personal Injury</option>
              <option>Family Law</option>
              <option>Criminal Defense</option>
              <option>Immigration</option>
              <option>Employment</option>
              <option>Real Estate</option>
              <option>Business</option>
              <option>Estate Planning</option>
              <option>Civil Litigation</option>
              <option>Other</option>
            </select>
          </div>
          <div>
            <label for="matterType">Matter Type</label>
            <input type="text" id="matterType" placeholder="e.g., MVA, Divorce, H-1B, ..." />
          </div>
          <div>
            <label for="referralSource">Referral Source</label>
            <input type="text" id="referralSource" placeholder="Google, Referral, Walk-in, ..." />
          </div>
          <div>
            <label for="assignedAttorney">Assigned Attorney</label>
            <input type="text" id="assignedAttorney" placeholder="Attorney Name" />
          </div>
        </div>

        <div class="row cols-4 align-end">
          <div>
            <label for="status">Status</label>
            <select id="status">
              <option>New</option>
              <option>In Review</option>
              <option>Consult Scheduled</option>
              <option>Retained</option>
              <option>Declined</option>
              <option>Conflict</option>
            </select>
          </div>
          <div>
            <label for="urgency">Urgency</label>
            <select id="urgency">
              <option>Low</option>
              <option>Medium</option>
              <option>High</option>
            </select>
          </div>
          <div>
            <label for="conflictCheck">Conflict Check</label>
            <select id="conflictCheck">
              <option>Not Run</option>
              <option>No Conflict</option>
              <option>Potential Conflict</option>
              <option>Conflict</option>
            </select>
          </div>
          <div>
            <label for="feeType">Fee Type</label>
            <select id="feeType">
              <option>Unknown</option>
              <option>Hourly</option>
              <option>Contingency</option>
              <option>Flat</option>
            </select>
          </div>
        </div>

        <div class="row cols-4 align-end">
          <div>
            <label for="potentialValue">Potential Value ($)</label>
            <input type="number" id="potentialValue" min="0" step="100" placeholder="e.g., 10000" />
          </div>
          <div>
            <label for="followUpDate">Follow-up Date</label>
            <input type="date" id="followUpDate" />
          </div>
          <div>
            <label for="intakeOwner">Intake Owner</label>
            <input type="text" id="intakeOwner" placeholder="Staff handling intake" />
          </div>
          <div class="actions">
            <button type="submit">Add Intake</button>
            <button type="button" class="secondary" id="resetFormBtn">Reset</button>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="notes">Notes</label>
            <textarea id="notes" placeholder="Key facts, next steps, conflicts detail, etc."></textarea>
            <div class="inline-help">Do not include privileged information you wouldn’t email internally. Keep sensitive data minimal.</div>
          </div>
        </div>
      </form>
    </section>

    <!-- Today's Intakes (now full-width and between sections) -->
    <section id="intakesSection" aria-labelledby="intakesTitle">
      <div class="flex">
        <h2 id="intakesTitle">Today's Intakes</h2>
        <span class="spacer"></span>
        <div class="flex">
          <label for="filterDate" class="sr-only">Filter Date</label>
          <input type="date" id="filterDate" />
          <button class="secondary" id="clearFilterBtn">Today</button>
        </div>
      </div>

      <div class="totals" id="totalsBar"></div>

      <div class="actions">
        <button class="secondary" id="exportJsonBtn">Export JSON</button>
        <button class="secondary" id="importJsonBtn">Import JSON</button>
        <input type="file" id="importFile" accept=".json" class="hidden" />
        <button class="secondary" id="downloadCsvBtn">Download CSV</button>
        <button class="secondary" id="purgeBtn" title="Remove all entries">Purge</button>
      </div>

      <div class="table-wrap">
        <table id="intakesTable" aria-describedby="intakesTitle">
          <thead>
            <tr>
              <th class="nowrap">Date</th>
              <th>Client</th>
              <th>Contact</th>
              <th>Practice • Matter</th>
              <th>Assigned</th>
              <th>Status</th>
              <th>Urgency</th>
              <th>Conflict</th>
              <th class="right">Value</th>
              <th>Follow-up</th>
              <th>Owner</th>
              <th>Notes</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="intakesTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- Email Summary and Recipients -->
    <section id="emailSection" aria-labelledby="emailTitle">
      <h2 id="emailTitle">End-of-Day Summary</h2>

      <div class="row cols-2">
        <div>
          <label for="emailSubject">Email Subject</label>
          <input type="text" id="emailSubject" />
        </div>
        <div>
          <label for="sendTime">Planned Send Time</label>
          <input type="time" id="sendTime" />
          <div class="inline-help">Use this as a reminder; automated sending requires the backend function and a scheduled job.</div>
        </div>
      </div>

      <div class="row cols-2">
        <div>
          <label>Recipients</label>
          <div id="recipientsList" class="grid"></div>
          <div class="actions mt-8">
            <button class="secondary" id="addRecipientBtn">Add Recipient</button>
          </div>
          <div id="recipientsEditor" class="mt-12">
            <details>
              <summary>Manage Recipients</summary>
              <div class="mt-8 grid cols-2" id="recipientEditorList"></div>
            </details>
          </div>

          <div class="mt-12">
            <label for="apiToken">Send API Token</label>
            <input type="password" id="apiToken" class="token-input" placeholder="Optional token for backend auth" />
            <div class="inline-help">Set SEND_TOKEN on your email function and enter it here before sending.</div>
          </div>

          <div class="actions mt-12">
            <button class="success" id="sendEmailBtn">Send via Email</button>
            <button class="secondary" id="copyHtmlBtn">Copy HTML</button>
            <button class="secondary" id="copyTextBtn">Copy Plain Text</button>
            <button class="secondary" id="printBtn">Print/PDF</button>
          </div>

          <div class="notice mt-12">
            To enable actual email sending, deploy the backend email function below and host this page with HTTPS.
          </div>
        </div>

        <div>
          <label>Preview</label>
          <div id="summaryPreview" class="codeblock" aria-live="polite" aria-busy="false"></div>
          <details class="mt-12">
            <summary>Plain text</summary>
            <pre id="summaryTextPreview" class="codeblock" style="white-space: pre-wrap;"></pre>
          </details>
        </div>
      </div>

      <div class="mt-16">
        <details>
          <summary>Backend Email Function (Node + Nodemailer) — copy and deploy</summary>
          <div class="mt-12">
            <div class="mb-8">
              Environment variables you must set:
              <ul>
                <li><span class="kbd">SMTP_HOST</span>, <span class="kbd">SMTP_PORT</span>, <span class="kbd">SMTP_SECURE</span> (true/false), <span class="kbd">SMTP_USER</span>, <span class="kbd">SMTP_PASS</span></li>
                <li><span class="kbd">FROM_EMAIL</span>: the From address (e.g., intake-bot@firm.com)</li>
                <li><span class="kbd">ALLOW_ORIGIN</span>: your site origin, e.g., https://intake.firm.com</li>
                <li><span class="kbd">SEND_TOKEN</span> (optional but recommended)</li>
              </ul>
            </div>

            <div class="mb-12">
              Option A: Vercel serverless (api/send-intake-summary.js)
            </div>
            <pre class="codeblock" id="vercelCode"></pre>

            <div class="mb-12 mt-16">
              Option B: Netlify Function (netlify/functions/send-intake-summary.js)
            </div>
            <pre class="codeblock" id="netlifyCode"></pre>
          </div>
        </details>
      </div>
    </section>
  </div>

  <div class="footer">
    Law Firm Intake Tracker — Local-only demo. Connect the email function to send summaries.
  </div>

  <script>
    // Utilities
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const store = {
      get(key, fallback) {
        try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; } catch { return fallback; }
      },
      set(key, val) { localStorage.setItem(key, JSON.stringify(val)); }
    };
    const todayStr = () => {
      const d = new Date();
      const tz = state.config.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone;
      const local = new Date(d.toLocaleString('en-US', { timeZone: tz }));
      const yyyy = local.getFullYear();
      const mm = String(local.getMonth()+1).padStart(2,'0');
      const dd = String(local.getDate()).padStart(2,'0');
      return `$${yyyy}-$${mm}-${dd}`;
    };
    const fmtDate = (iso) => {
      if (!iso) return '';
      const [y, m, d] = iso.split('-').map(x=>parseInt(x,10));
      const dt = new Date(y, (m-1), d);
      return dt.toLocaleDateString(undefined, { year:'numeric', month:'short', day:'numeric' });
    };
    const csvEscape = (s='') => `"${String(s).replace(/"/g, '""')}"`;

    // State
    const state = {
      entries: store.get('intakeEntries', []),
      recipients: store.get('intakeRecipients', [
        { id: cryptoRandom(), name: 'Intake Coordinator', email: 'intake@firm.com', role: 'Coordinator', enabled: true },
        { id: cryptoRandom(), name: 'Partners', email: 'partners@firm.com', role: 'Partners', enabled: true }
      ]),
      config: store.get('intakeConfig', {
        firmName: '',
        replyTo: '',
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        plannedSendTime: '17:00',
      }),
      filterDate: null, // defaults to today
      editingId: null
    };

    function cryptoRandom() {
      if (window.crypto?.getRandomValues) {
        const buf = new Uint32Array(2); crypto.getRandomValues(buf);
        return [...buf].map(n=>n.toString(16)).join('');
      }
      return String(Math.random()).slice(2);
    }

    // Init Timezone Select
    function populateTimezones() {
      const tzs = Intl.supportedValuesOf ? Intl.supportedValuesOf('timeZone') : [state.config.timezone];
      const sel = $('#timezoneSelect');
      sel.innerHTML = tzs.map(z => `<option value="$${z}">$${z}</option>`).join('');
      sel.value = state.config.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone;
    }

    // Form Controls
    function initForm() {
      $('#intakeDate').value = todayStr();
      $('#firmName').value = state.config.firmName || '';
      $('#replyToEmail').value = state.config.replyTo || '';
      $('#sendTime').value = state.config.plannedSendTime || '17:00';
      populateTimezones();

      // Events
      $('#firmName').addEventListener('input', e => {
        state.config.firmName = e.target.value.trim();
        persist();
        refreshSubject();
      });
      $('#replyToEmail').addEventListener('input', e => {
        state.config.replyTo = e.target.value.trim();
        persist();
      });
      $('#timezoneSelect').addEventListener('change', e => {
        state.config.timezone = e.target.value;
        persist();
        $('#intakeDate').value = todayStr();
        if (!state.filterDate) $('#filterDate').value = todayStr();
        draw();
      });
      $('#sendTime').addEventListener('change', e => {
        state.config.plannedSendTime = e.target.value;
        persist();
      });
      $('#intakeForm').addEventListener('submit', onSubmitIntake);
      $('#resetFormBtn').addEventListener('click', () => {
        state.editingId = null; $$('#intakeForm').reset(); $$('#intakeDate').value = todayStr();
      });
      $('#filterDate').value = todayStr();
      state.filterDate = $('#filterDate').value;
      $('#filterDate').addEventListener('change', e => { state.filterDate = e.target.value; draw(); });
      $$('#clearFilterBtn').addEventListener('click', () => { state.filterDate = todayStr(); $$('#filterDate').value = state.filterDate; draw(); });

      $('#exportJsonBtn').addEventListener('click', exportJson);
      $$('#importJsonBtn').addEventListener('click', () => $$('#importFile').click());
      $('#importFile').addEventListener('change', importJson);
      $('#downloadCsvBtn').addEventListener('click', downloadCsv);
      $('#purgeBtn').addEventListener('click', purgeAll);

      $('#addRecipientBtn').addEventListener('click', addRecipientPrompt);
      $('#sendEmailBtn').addEventListener('click', sendEmail);
      $('#copyHtmlBtn').addEventListener('click', copyHtml);
      $('#copyTextBtn').addEventListener('click', copyText);
      $('#printBtn').addEventListener('click', () => window.print());

      refreshSubject();
      renderRecipients();
      renderRecipientEditor();
      renderVercelCode();
      renderNetlifyCode();
      draw();
   
