<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Law Firm Daily Intake Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f7f7fb;
      --panel: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --accent: #1f6feb;
      --accent-2: #0ea5e9;
      --danger: #dc2626;
      --success: #16a34a;
      --warning: #d97706;
      --border: #e5e7eb;
      --radius: 10px;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg); color: var(--text);
    }
    header {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: white; padding: 24px 16px;
    }
    header .inner { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; gap: 16px; flex-wrap: wrap; }
    header h1 { margin: 0; font-size: 22px; }
    header .firm {
      display: flex; gap: 8px; align-items: center;
      background: rgba(255,255,255,0.15); padding: 8px 12px; border-radius: 8px;
    }
    header input, header select {
      border: none; outline: none; background: transparent; color: #fff; border-bottom: 1px dashed rgba(255,255,255,0.6);
    }
    .container { max-width: 1200px; margin: 20px auto; padding: 0 16px 48px; display: grid; grid-template-columns: 1fr; gap: 20px; }
    @media (min-width: 1080px) {
      /* Keep a single column at larger widths to make all boxes full-width */
      .container { grid-template-columns: 1fr; }
    }
    section {
      background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    section h2 { margin: 0 0 12px; font-size: 18px; }
    .row { display: grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 720px) {
      .row.cols-2 { grid-template-columns: 1fr 1fr; }
      .row.cols-3 { grid-template-columns: 1fr 1fr 1fr; }
      .row.cols-4 { grid-template-columns: 1fr 1fr 1fr 1fr; }
    }
    label { font-size: 13px; color: var(--muted); display: block; margin-bottom: 4px; }
    input[type="text"], input[type="email"], input[type="tel"], input[type="date"], input[type="number"], select, textarea {
      width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: #fff; color: var(--text);
    }
    textarea { min-height: 80px; resize: vertical; }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    button, .btn {
      appearance: none; border: none; background: var(--accent); color: #fff; padding: 10px 14px; border-radius: 8px; cursor: pointer; font-weight: 600;
      box-shadow: 0 1px 0 rgba(0,0,0,0.06);
    }
    button.secondary, .btn.secondary { background: #f3f4f6; color: #111827; border: 1px solid var(--border); }
    button.danger { background: var(--danger); }
    button.success { background: var(--success); }
    button.warning { background: var(--warning); }
    .muted { color: var(--muted); font-size: 12px; }
    .table-wrap { overflow: auto; border: 1px solid var(--border); border-radius: 8px; }
    table { border-collapse: collapse; width: 100%; min-width: 900px; }
    th, td { padding: 10px; border-bottom: 1px solid var(--border); text-align: left; vertical-align: top; font-size: 14px; }
    th { background: #f8fafc; position: sticky; top: 0; z-index: 1; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; font-weight: 600; }
    .pill.status-new { background: #e5f0ff; color: #1f6feb; }
    .pill.status-review { background: #fff3cd; color: #92400e; }
    .pill.status-retained { background: #dcfce7; color: #166534; }
    .pill.status-declined { background: #fee2e2; color: #991b1b; }
    .pill.status-conflict { background: #ffe4e6; color: #9f1239; }
    .pill.urgency-high { background: #fee2e2; color: #b91c1c; }
    .pill.urgency-medium { background: #fff7ed; color: #b45309; }
    .pill.urgency-low { background: #ecfeff; color: #0e7490; }
    .totals { display: flex; flex-wrap: wrap; gap: 10px; margin: 8px 0; }
    .totals .card {
      background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 8px 10px; font-size: 13px; color: #111827;
    }
    details { background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 8px 10px; }
    details summary { cursor: pointer; font-weight: 600; }
    .badge { font-size: 12px; background: #eef2ff; color: #4338ca; padding: 2px 6px; border-radius: 8px; }
    .grid { display: grid; gap: 10px; grid-template-columns: 1fr; }
    @media (min-width: 720px) { .grid.cols-2 { grid-template-columns: 1fr 1fr; } }
    .recipient { display: flex; align-items: center; gap: 8px; padding: 8px; border: 1px solid var(--border); border-radius: 8px; background: #fff; }
    .footer { text-align: center; color: var(--muted); font-size: 12px; padding: 20px 0 60px; }
    .hr { height: 1px; background: var(--border); margin: 10px 0; }
    .token-input { width: 100%; max-width: 280px; }
    .notice { background: #fffbeb; border: 1px solid #fde68a; color: #92400e; padding: 8px 10px; border-radius: 8px; font-size: 13px; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; background: #111827; color: #fff; padding: 2px 6px; border-radius: 6px; font-size: 12px; }
    .codeblock { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; white-space: pre; background: #0b1021; color: #e5e7eb; padding: 10px; border-radius: 8px; overflow: auto; font-size: 12px; line-height: 1.4; }
    .inline-help { font-size: 12px; color: var(--muted); }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }
    .soft { color: var(--muted); }
    .right { text-align: right; }
    .flex { display: flex; gap: 8px; align-items: center; }
    .spacer { flex: 1; }
    .sm { font-size: 12px; }
    .mb-8 { margin-bottom: 8px; }
    .mb-12 { margin-bottom: 12px; }
    .mb-4 { margin-bottom: 4px; }
    .mt-8 { margin-top: 8px; }
    .mt-12 { margin-top: 12px; }
    .mt-16 { margin-top: 16px; }
    .w-100 { width: 100%; }
    .align-end { align-items: end; }
    .nowrap { white-space: nowrap; }
    .hidden { display: none; }

    /* Print summary only */
    @media print {
      body { background: #fff; }
      header, #entryFormSection, #intakesSection .actions, #emailSection .actions, #emailSection #recipientsEditor, #emailSection .notice, #emailSection details, .footer { display: none !important; }
      #summaryPreview { display: block !important; }
      section { border: none; box-shadow: none; }
    }
  </style>
</head>
<body>
  <header>
    <div class="inner">
      <h1>Daily Intake Tracker</h1>
      <div class="firm">
        <span>Firm:</span>
        <input id="firmName" type="text" placeholder="Firm Name" />
        <span class="sr-only">Timezone</span>
        <select id="timezoneSelect" title="Reporting Timezone"></select>
      </div>
      <div class="firm">
        <span>Reply-To:</span>
        <input id="replyToEmail" type="email" placeholder="reply@firm.com" />
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Intake Entry Form -->
    <section id="entryFormSection" aria-labelledby="entryFormTitle">
      <h2 id="entryFormTitle">New Intake</h2>
      <form id="intakeForm">
        <div class="row cols-4">
          <div>
            <label for="intakeDate">Date</label>
            <input type="date" id="intakeDate" required />
          </div>
          <div>
            <label for="clientName">Client Name</label>
            <input type="text" id="clientName" placeholder="Jane Doe" required />
          </div>
          <div>
            <label for="clientEmail">Email</label>
            <input type="email" id="clientEmail" placeholder="jane@example.com" />
          </div>
          <div>
            <label for="clientPhone">Phone</label>
            <input type="tel" id="clientPhone" placeholder="(555) 555-5555" />
          </div>
        </div>

        <div class="row cols-4">
          <div>
            <label for="practiceArea">Practice Area</label>
            <select id="practiceArea">
              <option value="">Select...</option>
              <option>Personal Injury</option>
              <option>Family Law</option>
              <option>Criminal Defense</option>
              <option>Immigration</option>
              <option>Employment</option>
              <option>Real Estate</option>
              <option>Business</option>
              <option>Estate Planning</option>
              <option>Civil Litigation</option>
              <option>Other</option>
            </select>
          </div>
          <div>
            <label for="matterType">Matter Type</label>
            <input type="text" id="matterType" placeholder="e.g., MVA, Divorce, H-1B, ..." />
          </div>
          <div>
            <label for="referralSource">Referral Source</label>
            <input type="text" id="referralSource" placeholder="Google, Referral, Walk-in, ..." />
          </div>
          <div>
            <label for="assignedAttorney">Assigned Attorney</label>
            <input type="text" id="assignedAttorney" placeholder="Attorney Name" />
          </div>
        </div>

        <div class="row cols-4 align-end">
          <div>
            <label for="status">Status</label>
            <select id="status">
              <option>New</option>
              <option>In Review</option>
              <option>Consult Scheduled</option>
              <option>Retained</option>
              <option>Declined</option>
              <option>Conflict</option>
            </select>
          </div>
          <div>
            <label for="urgency">Urgency</label>
            <select id="urgency">
              <option>Low</option>
              <option>Medium</option>
              <option>High</option>
            </select>
          </div>
          <div>
            <label for="conflictCheck">Conflict Check</label>
            <select id="conflictCheck">
              <option>Not Run</option>
              <option>No Conflict</option>
              <option>Potential Conflict</option>
              <option>Conflict</option>
            </select>
          </div>
          <div>
            <label for="feeType">Fee Type</label>
            <select id="feeType">
              <option>Unknown</option>
              <option>Hourly</option>
              <option>Contingency</option>
              <option>Flat</option>
            </select>
          </div>
        </div>

        <div class="row cols-4 align-end">
          <div>
            <label for="potentialValue">Potential Value ($)</label>
            <input type="number" id="potentialValue" min="0" step="100" placeholder="e.g., 10000" />
          </div>
          <div>
            <label for="followUpDate">Follow-up Date</label>
            <input type="date" id="followUpDate" />
          </div>
          <div>
            <label for="intakeOwner">Intake Owner</label>
            <input type="text" id="intakeOwner" placeholder="Staff handling intake" />
          </div>
          <div class="actions">
            <button type="submit">Add Intake</button>
            <button type="button" class="secondary" id="resetFormBtn">Reset</button>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="notes">Notes</label>
            <textarea id="notes" placeholder="Key facts, next steps, conflicts detail, etc."></textarea>
            <div class="inline-help">Do not include privileged information you wouldn’t email internally. Keep sensitive data minimal.</div>
          </div>
        </div>
      </form>
    </section>

    <!-- Today's Intakes -->
    <section id="intakesSection" aria-labelledby="intakesTitle">
      <div class="flex">
        <h2 id="intakesTitle">Today's Intakes</h2>
        <span class="spacer"></span>
        <div class="flex">
          <label for="filterDate" class="sr-only">Filter Date</label>
          <input type="date" id="filterDate" />
          <button class="secondary" id="clearFilterBtn">Today</button>
        </div>
      </div>

      <div class="totals" id="totalsBar"></div>

      <div class="actions">
        <button class="secondary" id="exportJsonBtn">Export JSON</button>
        <button class="secondary" id="importJsonBtn">Import JSON</button>
        <input type="file" id="importFile" accept=".json" class="hidden" />
        <button class="secondary" id="downloadCsvBtn">Download CSV</button>
        <button class="secondary" id="purgeBtn" title="Remove all entries">Purge</button>
      </div>

      <div class="table-wrap">
        <table id="intakesTable" aria-describedby="intakesTitle">
          <thead>
            <tr>
              <th class="nowrap">Date</th>
              <th>Client</th>
              <th>Contact</th>
              <th>Practice • Matter</th>
              <th>Assigned</th>
              <th>Status</th>
              <th>Urgency</th>
              <th>Conflict</th>
              <th class="right">Value</th>
              <th>Follow-up</th>
              <th>Owner</th>
              <th>Notes</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="intakesTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- Email Summary and Recipients -->
    <section id="emailSection" aria-labelledby="emailTitle">
      <h2 id="emailTitle">End-of-Day Summary</h2>

      <div class="row cols-2">
        <div>
          <label for="emailSubject">Email Subject</label>
          <input type="text" id="emailSubject" />
        </div>
        <div>
          <label for="sendTime">Planned Send Time</label>
          <input type="time" id="sendTime" />
          <div class="inline-help">Use this as a reminder; automated sending requires the backend function and a scheduled job.</div>
        </div>
      </div>

      <div class="row cols-2">
        <div>
          <label>Recipients</label>
          <div id="recipientsList" class="grid"></div>
          <div class="actions mt-8">
            <button class="secondary" id="addRecipientBtn">Add Recipient</button>
          </div>
          <div id="recipientsEditor" class="mt-12">
            <details>
              <summary>Manage Recipients</summary>
              <div class="mt-8 grid cols-2" id="recipientEditorList"></div>
            </details>
          </div>

          <div class="mt-12">
            <label for="apiToken">Send API Token</label>
            <input type="password" id="apiToken" class="token-input" placeholder="Optional token for backend auth" />
            <div class="inline-help">Set SEND_TOKEN on your email function and enter it here before sending.</div>
          </div>

          <div class="actions mt-12">
            <button class="success" id="sendEmailBtn">Send via Email</button>
            <button class="secondary" id="copyHtmlBtn">Copy HTML</button>
            <button class="secondary" id="copyTextBtn">Copy Plain Text</button>
            <button class="secondary" id="printBtn">Print/PDF</button>
          </div>

          <div class="notice mt-12">
            To enable actual email sending, deploy the backend email function below and host this page with HTTPS.
          </div>
        </div>

        <div>
          <label>Preview</label>
          <div id="summaryPreview" class="codeblock" aria-live="polite" aria-busy="false"></div>
          <details class="mt-12">
            <summary>Plain text</summary>
            <pre id="summaryTextPreview" class="codeblock" style="white-space: pre-wrap;"></pre>
          </details>
        </div>
      </div>

      <div class="mt-16">
        <details>
          <summary>Backend Email Function (Node + Nodemailer) — copy and deploy</summary>
          <div class="mt-12">
            <div class="mb-8">
              Environment variables you must set:
              <ul>
                <li><span class="kbd">SMTP_HOST</span>, <span class="kbd">SMTP_PORT</span>, <span class="kbd">SMTP_SECURE</span> (true/false), <span class="kbd">SMTP_USER</span>, <span class="kbd">SMTP_PASS</span></li>
                <li><span class="kbd">FROM_EMAIL</span>: the From address (e.g., intake-bot@firm.com)</li>
                <li><span class="kbd">ALLOW_ORIGIN</span>: your site origin, e.g., https://intake.firm.com</li>
                <li><span class="kbd">SEND_TOKEN</span> (optional but recommended)</li>
              </ul>
            </div>

            <div class="mb-12">
              Option A: Vercel serverless (api/send-intake-summary.js)
            </div>
            <pre class="codeblock" id="vercelCode"></pre>

            <div class="mb-12 mt-16">
              Option B: Netlify Function (netlify/functions/send-intake-summary.js)
            </div>
            <pre class="codeblock" id="netlifyCode"></pre>
          </div>
        </details>
      </div>
    </section>
  </div>

  <div class="footer">
    Law Firm Intake Tracker — Local-only demo. Connect the email function to send summaries.
  </div>

  <script>
    // Utilities
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const store = {
      get(key, fallback) {
        try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; } catch { return fallback; }
      },
      set(key, val) { localStorage.setItem(key, JSON.stringify(val)); }
    };
    const todayStr = () => {
      const d = new Date();
      const tz = state.config.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone;
      const local = new Date(d.toLocaleString('en-US', { timeZone: tz }));
      const yyyy = local.getFullYear();
      const mm = String(local.getMonth()+1).padStart(2,'0');
      const dd = String(local.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    };
    const fmtDate = (iso) => {
      if (!iso) return '';
      const [y, m, d] = iso.split('-').map(x=>parseInt(x,10));
      const dt = new Date(y, (m-1), d);
      return dt.toLocaleDateString(undefined, { year:'numeric', month:'short', day:'numeric' });
    };
    const csvEscape = (s='') => `"${String(s).replace(/"/g, '""')}"`;

    // State
    const state = {
      entries: store.get('intakeEntries', []),
      recipients: store.get('intakeRecipients', [
        { id: cryptoRandom(), name: 'Intake Coordinator', email: 'intake@firm.com', role: 'Coordinator', enabled: true },
        { id: cryptoRandom(), name: 'Partners', email: 'partners@firm.com', role: 'Partners', enabled: true }
      ]),
      config: store.get('intakeConfig', {
        firmName: '',
        replyTo: '',
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        plannedSendTime: '17:00',
      }),
      filterDate: null, // defaults to today
      editingId: null
    };

    function cryptoRandom() {
      if (window.crypto?.getRandomValues) {
        const buf = new Uint32Array(2); crypto.getRandomValues(buf);
        return [...buf].map(n=>n.toString(16)).join('');
      }
      return String(Math.random()).slice(2);
    }

    // Init Timezone Select
    function populateTimezones() {
      const tzs = Intl.supportedValuesOf ? Intl.supportedValuesOf('timeZone') : [state.config.timezone];
      const sel = $('#timezoneSelect');
      sel.innerHTML = tzs.map(z => `<option value="${z}">${z}</option>`).join('');
      sel.value = state.config.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone;
    }

    // Form Controls
    function initForm() {
      $('#intakeDate').value = todayStr();
      $('#firmName').value = state.config.firmName || '';
      $('#replyToEmail').value = state.config.replyTo || '';
      $('#sendTime').value = state.config.plannedSendTime || '17:00';
      populateTimezones();

      // Events
      $('#firmName').addEventListener('input', e => {
        state.config.firmName = e.target.value.trim();
        persist();
        refreshSubject();
      });
      $('#replyToEmail').addEventListener('input', e => {
        state.config.replyTo = e.target.value.trim();
        persist();
      });
      $('#timezoneSelect').addEventListener('change', e => {
        state.config.timezone = e.target.value;
        persist();
        $('#intakeDate').value = todayStr();
        if (!state.filterDate) $('#filterDate').value = todayStr();
        draw();
      });
      $('#sendTime').addEventListener('change', e => {
        state.config.plannedSendTime = e.target.value;
        persist();
      });
      $('#intakeForm').addEventListener('submit', onSubmitIntake);
      $('#resetFormBtn').addEventListener('click', () => {
        state.editingId = null; $('#intakeForm').reset(); $('#intakeDate').value = todayStr();
      });
      $('#filterDate').value = todayStr();
      state.filterDate = $('#filterDate').value;
      $('#filterDate').addEventListener('change', e => { state.filterDate = e.target.value; draw(); });
      $('#clearFilterBtn').addEventListener('click', () => { state.filterDate = todayStr(); $('#filterDate').value = state.filterDate; draw(); });

      $('#exportJsonBtn').addEventListener('click', exportJson);
      $('#importJsonBtn').addEventListener('click', () => $('#importFile').click());
      $('#importFile').addEventListener('change', importJson);
      $('#downloadCsvBtn').addEventListener('click', downloadCsv);
      $('#purgeBtn').addEventListener('click', purgeAll);

      $('#addRecipientBtn').addEventListener('click', addRecipientPrompt);
      $('#sendEmailBtn').addEventListener('click', sendEmail);
      $('#copyHtmlBtn').addEventListener('click', copyHtml);
      $('#copyTextBtn').addEventListener('click', copyText);
      $('#printBtn').addEventListener('click', () => window.print());

      refreshSubject();
      renderRecipients();
      renderRecipientEditor();
      renderVercelCode();
      renderNetlifyCode();
      draw();
    }

    function persist() {
      store.set('intakeEntries', state.entries);
      store.set('intakeRecipients', state.recipients);
      store.set('intakeConfig', state.config);
    }

    function onSubmitIntake(e) {
      e.preventDefault();
      const get = id => $(id.startsWith('#') ? id : `#${id}`).value.trim();
      const entry = {
        id: state.editingId || cryptoRandom(),
        date: $('#intakeDate').value,
        clientName: get('clientName'),
        clientEmail: get('clientEmail'),
        clientPhone: get('clientPhone'),
        practiceArea: get('practiceArea'),
        matterType: get('matterType'),
        referralSource: get('referralSource'),
        assignedAttorney: get('assignedAttorney'),
        status: $('#status').value,
        urgency: $('#urgency').value,
        conflictCheck: $('#conflictCheck').value,
        feeType: $('#feeType').value,
        potentialValue: parseFloat($('#potentialValue').value || '0'),
        followUpDate: $('#followUpDate').value,
        intakeOwner: get('intakeOwner'),
        notes: $('#notes').value.trim()
      };
      if (!entry.clientName) { alert('Client name is required'); return; }
      if (!entry.date) { alert('Date is required'); return; }
      if (state.editingId) {
        const idx = state.entries.findIndex(x => x.id === state.editingId);
        if (idx >= 0) state.entries[idx] = entry;
        state.editingId = null;
      } else {
        state.entries.push(entry);
      }
      persist();
      $('#intakeForm').reset();
      $('#intakeDate').value = todayStr();
      draw();
    }

    function editEntry(id) {
      const e = state.entries.find(x => x.id === id);
      if (!e) return;
      state.editingId = id;
      $('#intakeDate').value = e.date || todayStr();
      $('#clientName').value = e.clientName || '';
      $('#clientEmail').value = e.clientEmail || '';
      $('#clientPhone').value = e.clientPhone || '';
      $('#practiceArea').value = e.practiceArea || '';
      $('#matterType').value = e.matterType || '';
      $('#referralSource').value = e.referralSource || '';
      $('#assignedAttorney').value = e.assignedAttorney || '';
      $('#status').value = e.status || 'New';
      $('#urgency').value = e.urgency || 'Low';
      $('#conflictCheck').value = e.conflictCheck || 'Not Run';
      $('#feeType').value = e.feeType || 'Unknown';
      $('#potentialValue').value = e.potentialValue || '';
      $('#followUpDate').value = e.followUpDate || '';
      $('#intakeOwner').value = e.intakeOwner || '';
      $('#notes').value = e.notes || '';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function deleteEntry(id) {
      if (!confirm('Delete this intake entry?')) return;
      state.entries = state.entries.filter(x => x.id !== id);
      persist();
      draw();
    }

    function draw() {
      const filtered = state.entries.filter(e => !state.filterDate || e.date === state.filterDate);
      // Table
      const tbody = $('#intakesTbody'); tbody.innerHTML = '';
      filtered.sort((a,b) => (a.urgency === 'High' ? -1 : 1)).forEach(e => {
        const tr = document.createElement('tr');
        const email = e.clientEmail ? `<div><a href="mailto:${escapeHtml(e.clientEmail)}">${escapeHtml(e.clientEmail)}</a></div>` : '';
        const phone = e.clientPhone ? `<div>${escapeHtml(e.clientPhone)}</div>` : '';
        tr.innerHTML = `
          <td>${fmtDate(e.date)}</td>
          <td><strong>${escapeHtml(e.clientName || '')}</strong></td>
          <td>${email}${phone}</td>
          <td><div><strong>${escapeHtml(e.practiceArea || '')}</strong></div><div class="soft">${escapeHtml(e.matterType || '')}</div></td>
          <td>${escapeHtml(e.assignedAttorney || '')}</td>
          <td>${statusPill(e.status)}</td>
          <td>${urgencyPill(e.urgency)}</td>
          <td><span class="pill">${escapeHtml(e.conflictCheck || '')}</span></td>
          <td class="right">${e.potentialValue ? ('$' + e.potentialValue.toLocaleString()) : ''}</td>
          <td>${e.followUpDate ? fmtDate(e.followUpDate) : ''}</td>
          <td>${escapeHtml(e.intakeOwner || '')}</td>
          <td>${escapeHtml(e.notes || '')}</td>
          <td>
            <div class="flex">
              <button class="secondary sm" onclick="editEntry('${e.id}')">Edit</button>
              <button class="danger sm" onclick="deleteEntry('${e.id}')">Delete</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });

      renderTotals(filtered);
      refreshSubject();
      renderSummaryPreviews(filtered);
    }

    function renderTotals(entries) {
      const totals = {
        count: entries.length,
        retained: entries.filter(e => e.status === 'Retained').length,
        declined: entries.filter(e => e.status === 'Declined').length,
        conflict: entries.filter(e => e.status === 'Conflict' || e.conflictCheck === 'Conflict').length,
        consults: entries.filter(e => e.status === 'Consult Scheduled').length,
        potential: entries.reduce((sum, e) => sum + (e.potentialValue || 0), 0),
      };
      const byPractice = groupCount(entries, e => e.practiceArea || 'Unspecified');
      const bySource = groupCount(entries, e => e.referralSource || 'Unspecified');

      const bar = $('#totalsBar'); bar.innerHTML = '';
      const makeCard = (label, value) => {
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `<strong>${value}</strong> ${label}`;
        return div;
      };
      bar.appendChild(makeCard('Total', totals.count));
      bar.appendChild(makeCard('Retained', totals.retained));
      bar.appendChild(makeCard('Consults', totals.consults));
      bar.appendChild(makeCard('Declined', totals.declined));
      bar.appendChild(makeCard('Conflicts', totals.conflict));
      bar.appendChild(makeCard('Potential $', '$' + totals.potential.toLocaleString()));
      const topPractice = Object.entries(byPractice).sort((a,b)=>b[1]-a[1])[0];
      const topSource = Object.entries(bySource).sort((a,b)=>b[1]-a[1])[0];
      if (topPractice) bar.appendChild(makeCard('Top Practice', `${topPractice[0]} (${topPractice[1]})`));
      if (topSource) bar.appendChild(makeCard('Top Source', `${topSource[0]} (${topSource[1]})`));
    }

    function groupCount(items, keyFn) {
      const map = {};
      items.forEach(it => { const k = keyFn(it); map[k] = (map[k]||0)+1; });
      return map;
    }

    function statusPill(status='New') {
      const map = {
        'New': 'status-new',
        'In Review': 'status-review',
        'Consult Scheduled': 'status-review',
        'Retained': 'status-retained',
        'Declined': 'status-declined',
        'Conflict': 'status-conflict'
      };
      const cls = map[status] || 'status-new';
      return `<span class="pill ${cls}">${escapeHtml(status)}</span>`;
    }
    function urgencyPill(u='Low') {
      const map = { 'High':'urgency-high', 'Medium':'urgency-medium', 'Low':'urgency-low' };
      return `<span class="pill ${map[u] || 'urgency-low'}">${escapeHtml(u)}</span>`;
    }
    function escapeHtml(s='') {
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#39;");
    }

    // Export/Import
    function exportJson() {
      const data = { entries: state.entries, recipients: state.recipients, config: state.config };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `intake-export-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    }
    function importJson(e) {
      const file = e.target.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          if (data.entries) state.entries = data.entries;
          if (data.recipients) state.recipients = data.recipients;
          if (data.config) state.config = { ...state.config, ...data.config };
          persist(); initForm();
          alert('Import successful.');
        } catch(err) { alert('Invalid JSON file.'); }
      };
      reader.readAsText(file);
    }
    function downloadCsv() {
      const cols = ['date','clientName','clientEmail','clientPhone','practiceArea','matterType','referralSource','assignedAttorney','status','urgency','conflictCheck','feeType','potentialValue','followUpDate','intakeOwner','notes'];
      const header = cols.map(csvEscape).join(',') + '\n';
      const rows = state.entries.map(e => cols.map(k => csvEscape(e[k] ?? '')).join(',')).join('\n');
      const blob = new Blob([header + rows], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `intakes-${Date.now()}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
    }
    function purgeAll() {
      if (!confirm('This will delete ALL entries stored locally on this browser. Continue?')) return;
      state.entries = [];
      persist(); draw();
    }

    // Recipients
    function renderRecipients() {
      const container = $('#recipientsList'); container.innerHTML = '';
      state.recipients.forEach(r => {
        const div = document.createElement('div');
        div.className = 'recipient';
        div.innerHTML = `
          <input type="checkbox" ${r.enabled ? 'checked':''} id="rec-${r.id}" />
          <div>
            <div><strong>${escapeHtml(r.name)}</strong> <span class="badge">${escapeHtml(r.role || '')}</span></div>
            <div class="soft">${escapeHtml(r.email)}</div>
          </div>
        `;
        container.appendChild(div);
        $('#rec-'+r.id).addEventListener('change', ev => {
          r.enabled = ev.target.checked; persist();
        });
      });
    }

    function renderRecipientEditor() {
      const list = $('#recipientEditorList'); list.innerHTML = '';
      state.recipients.forEach(r => {
        const wrapper = document.createElement('div');
        wrapper.innerHTML = `
          <div class="recipient">
            <div class="w-100 grid">
              <div class="row cols-2">
                <div>
                  <label>Name</label>
                  <input type="text" value="${escapeAttr(r.name)}" data-k="name" data-id="${r.id}" />
                </div>
                <div>
                  <label>Role</label>
                  <input type="text" value="${escapeAttr(r.role || '')}" data-k="role" data-id="${r.id}" />
                </div>
              </div>
              <div class="row cols-2">
                <div>
                  <label>Email</label>
                  <input type="email" value="${escapeAttr(r.email)}" data-k="email" data-id="${r.id}" />
                </div>
                <div class="flex" style="align-items: flex-end;">
                  <label class="sr-only">Enabled</label>
                  <input type="checkbox" ${r.enabled ? 'checked':''} data-k="enabled" data-id="${r.id}" />
                  <span class="spacer"></span>
                  <button class="danger sm" data-action="remove" data-id="${r.id}">Remove</button>
                </div>
              </div>
            </div>
          </div>
        `;
        list.appendChild(wrapper);
      });
      // Wire inputs
      $$('input[data-id]').forEach(inp => {
        inp.addEventListener('input', ev => {
          const id = ev.target.getAttribute('data-id');
          const key = ev.target.getAttribute('data-k');
          const r = state.recipients.find(x => x.id === id);
          if (!r) return;
          if (key === 'enabled') r.enabled = ev.target.checked;
          else r[key] = ev.target.value;
          persist(); renderRecipients();
        });
      });
      $$('button[data-action="remove"]').forEach(btn => {
        btn.addEventListener('click', ev => {
          const id = ev.target.getAttribute('data-id');
          if (!confirm('Remove this recipient?')) return;
          state.recipients = state.recipients.filter(x => x.id !== id);
          persist(); renderRecipients(); renderRecipientEditor();
        });
      });
    }

    function addRecipientPrompt() {
      const name = prompt('Recipient name:');
      if (!name) return;
      const email = prompt('Recipient email:');
      if (!email) return;
      const role = prompt('Role (e.g., Partners, Intake):') || '';
      const r = { id: cryptoRandom(), name, email, role, enabled: true };
      state.recipients.push(r); persist();
      renderRecipients(); renderRecipientEditor();
    }

    function escapeAttr(s='') {
      return String(s).replaceAll('"','&quot;');
    }

    // Email Subject and Summary
    function refreshSubject() {
      const d = state.filterDate || todayStr();
      const firm = state.config.firmName ? `${state.config.firmName} — ` : '';
      $('#emailSubject').value = `${firm}Daily Intake Summary — ${fmtDate(d)}`;
    }

    function renderSummaryPreviews(entries) {
      const { html, text } = buildSummary(entries);
      $('#summaryPreview').innerHTML = html;
      $('#summaryTextPreview').textContent = text;
    }

    function buildSummary(entries) {
      const d = state.filterDate || todayStr();
      const heading = `Daily Intake Summary — ${fmtDate(d)}`;
      const totals = {
        count: entries.length,
        retained: entries.filter(e => e.status === 'Retained').length,
        declined: entries.filter(e => e.status === 'Declined').length,
        conflict: entries.filter(e => e.status === 'Conflict' || e.conflictCheck === 'Conflict').length,
        consults: entries.filter(e => e.status === 'Consult Scheduled').length,
        potential: entries.reduce((sum, e) => sum + (e.potentialValue || 0), 0),
      };
      const byPractice = groupCount(entries, e => e.practiceArea || 'Unspecified');
      const bySource = groupCount(entries, e => e.referralSource || 'Unspecified');

      const style = `
        <style>
          body { font-family: -apple-system, Segoe UI, Roboto, Arial, sans-serif; color: #111827; }
          .soft { color: #6b7280; }
          .section { margin: 8px 0 16px; }
          table { border-collapse: collapse; width: 100%; }
          th, td { border: 1px solid #e5e7eb; padding: 6px 8px; text-align: left; vertical-align: top; }
          th { background: #f3f4f6; }
          .right { text-align: right; }
          .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; background:#eef2ff; color:#4338ca; }
        </style>
      `;

      const totalsHtml = `
        <div class="section">
          <strong>Totals:</strong>
          <ul>
            <li>Total: ${totals.count}</li>
            <li>Retained: ${totals.retained} • Consults: ${totals.consults} • Declined: ${totals.declined} • Conflicts: ${totals.conflict}</li>
            <li>Potential Value: $${totals.potential.toLocaleString()}</li>
          </ul>
        </div>
      `;

      const aggHtml = (title, obj) => `
        <div class="section">
          <strong>${title}:</strong>
          <ul>${Object.entries(obj).sort((a,b)=>b[1]-a[1]).map(([k,v]) => `<li>${escapeHtml(k)}: ${v}</li>`).join('')}</ul>
        </div>
      `;

      const tableHtml = `
        <div class="section">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Client</th>
                <th>Contact</th>
                <th>Practice • Matter</th>
                <th>Assigned</th>
                <th>Status</th>
                <th>Urgency</th>
                <th>Conflict</th>
                <th class="right">Value</th>
                <th>Follow-up</th>
                <th>Owner</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody>
              ${entries.map(e => `
                <tr>
                  <td>${fmtDate(e.date)}</td>
                  <td>${escapeHtml(e.clientName)}</td>
                  <td>${escapeHtml([e.clientEmail, e.clientPhone].filter(Boolean).join(' • '))}</td>
                  <td>${escapeHtml(e.practiceArea || '')} • <span class="soft">${escapeHtml(e.matterType || '')}</span></td>
                  <td>${escapeHtml(e.assignedAttorney || '')}</td>
                  <td>${escapeHtml(e.status)}</td>
                  <td>${escapeHtml(e.urgency)}</td>
                  <td>${escapeHtml(e.conflictCheck || '')}</td>
                  <td class="right">${e.potentialValue ? ('$' + e.potentialValue.toLocaleString()) : ''}</td>
                  <td>${e.followUpDate ? fmtDate(e.followUpDate) : ''}</td>
                  <td>${escapeHtml(e.intakeOwner || '')}</td>
                  <td>${escapeHtml(e.notes || '')}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;

      const html = `
        ${style}
        <h2>${escapeHtml(heading)}</h2>
        <div class="soft">${escapeHtml(state.config.firmName || '')}</div>
        ${totalsHtml}
        ${aggHtml('By Practice Area', byPractice)}
        ${aggHtml('By Referral Source', bySource)}
        ${tableHtml}
      `;

      const text = [
        heading,
        state.config.firmName || '',
        '',
        `Totals:`,
        `- Total: ${totals.count}`,
        `- Retained: ${totals.retained} • Consults: ${totals.consults} • Declined: ${totals.declined} • Conflicts: ${totals.conflict}`,
        `- Potential Value: $${totals.potential.toLocaleString()}`,
        '',
        'By Practice Area:',
        ...Object.entries(byPractice).sort((a,b)=>b[1]-a[1]).map(([k,v]) => `- ${k}: ${v}`),
        '',
        'By Referral Source:',
        ...Object.entries(bySource).sort((a,b)=>b[1]-a[1]).map(([k,v]) => `- ${k}: ${v}`),
        '',
        'Entries:',
        ...entries.map(e => [
          `• ${fmtDate(e.date)} — ${e.clientName} | ${e.practiceArea} • ${e.matterType || ''}`,
          `  Contact: ${[e.clientEmail, e.clientPhone].filter(Boolean).join(' • ') || '—'}`,
          `  Assigned: ${e.assignedAttorney || '—'} | Status: ${e.status} | Urgency: ${e.urgency} | Conflict: ${e.conflictCheck || '—'}`,
          `  Value: ${e.potentialValue ? ('$' + e.potentialValue.toLocaleString()) : '—'} | Follow-up: ${e.followUpDate ? fmtDate(e.followUpDate) : '—'} | Owner: ${e.intakeOwner || '—'}`,
          `  Notes: ${e.notes || '—'}`,
          ''
        ].join('\n'))
      ].join('\n');

      return { html, text };
    }

    async function copyHtml() {
      const entries = state.entries.filter(e => !state.filterDate || e.date === state.filterDate);
      const { html } = buildSummary(entries);
      await navigator.clipboard.writeText(html);
      alert('HTML copied to clipboard.');
    }
    async function copyText() {
      const entries = state.entries.filter(e => !state.filterDate || e.date === state.filterDate);
      const { text } = buildSummary(entries);
      await navigator.clipboard.writeText(text);
      alert('Plain text copied to clipboard.');
    }

    async function sendEmail() {
      const to = state.recipients.filter(r => r.enabled).map(r => r.email).filter(Boolean);
      if (!to.length) { alert('Please enable at least one recipient.'); return; }
      const subject = $('#emailSubject').value.trim() || 'Daily Intake Summary';
      const replyTo = state.config.replyTo || '';
      const entries = state.entries.filter(e => !state.filterDate || e.date === state.filterDate);
      const { html, text } = buildSummary(entries);
      const token = $('#apiToken').value.trim();

      try {
        const res = await fetch('/api/send-intake-summary', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ to, subject, html, text, replyTo, token })
        });
        if (!res.ok) {
          const msg = await res.text();
          throw new Error(msg || ('HTTP ' + res.status));
        }
        alert('Email sent successfully.');
      } catch (err) {
        alert('Failed to send email. Ensure the backend function is deployed and accessible.\n\nError: ' + err.message);
      }
    }

    // Backend code samples
    function renderVercelCode() {
      const code = `import nodemailer from 'nodemailer';

export default async function handler(req, res) {
  if (req.method !== 'POST') return res.status(405).send('Method Not Allowed');
  const origin = req.headers.origin || '';
  const allowOrigin = process.env.ALLOW_ORIGIN || '';
  if (allowOrigin && origin && origin !== allowOrigin) {
    return res.status(403).send('Forbidden origin');
  }
  const { to, subject, html, text, replyTo, token } = req.body || {};
  if (!Array.isArray(to) || !to.length) return res.status(400).send('Missing recipients');
  if (!subject || !html) return res.status(400).send('Missing subject or html');

  const requiredToken = process.env.SEND_TOKEN;
  if (requiredToken && token !== requiredToken) return res.status(401).send('Unauthorized');

  try {
    const transporter = nodemailer.createTransport({
      host: process.env.SMTP_HOST,
      port: parseInt(process.env.SMTP_PORT || '587', 10),
      secure: (process.env.SMTP_SECURE || 'false') === 'true',
      auth: {
        user: process.env.SMTP_USER,
        pass: process.env.SMTP_PASS
      }
    });

    const info = await transporter.sendMail({
      from: process.env.FROM_EMAIL,
      to: to.join(','),
      subject,
      html,
      text: text || undefined,
      replyTo: replyTo || undefined
    });

    return res.status(200).json({ ok: true, messageId: info.messageId });
  } catch (err) {
    console.error('Mailer error:', err);
    return res.status(500).send('Failed to send email');
  }
}
`;
      $('#vercelCode').textContent = code;
    }

    function renderNetlifyCode() {
      const code = `const nodemailer = require('nodemailer');

exports.handler = async function(event, context) {
  if (event.httpMethod !== 'POST') return { statusCode: 405, body: 'Method Not Allowed' };

  const origin = event.headers.origin || '';
  const allowOrigin = process.env.ALLOW_ORIGIN || '';
  if (allowOrigin && origin && origin !== allowOrigin) {
    return { statusCode: 403, body: 'Forbidden origin' };
  }

  let payload;
  try { payload = JSON.parse(event.body || '{}'); } catch { return { statusCode: 400, body: 'Invalid JSON' }; }
  const { to, subject, html, text, replyTo, token } = payload;
  if (!Array.isArray(to) || !to.length) return { statusCode: 400, body: 'Missing recipients' };
  if (!subject || !html) return { statusCode: 400, body: 'Missing subject or html' };

  const requiredToken = process.env.SEND_TOKEN;
  if (requiredToken && token !== requiredToken) return { statusCode: 401, body: 'Unauthorized' };

  try {
    const transporter = nodemailer.createTransport({
      host: process.env.SMTP_HOST,
      port: parseInt(process.env.SMTP_PORT || '587', 10),
      secure: (process.env.SMTP_SECURE || 'false') === 'true',
      auth: {
        user: process.env.SMTP_USER,
        pass: process.env.SMTP_PASS
      }
    });

    const info = await transporter.sendMail({
      from: process.env.FROM_EMAIL,
      to: to.join(','),
      subject,
      html,
      text: text || undefined,
      replyTo: replyTo || undefined
    });

    return {
      statusCode: 200,
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify({ ok: true, messageId: info.messageId })
    };
  } catch (err) {
    console.error('Mailer error:', err);
    return { statusCode: 500, body: 'Failed to send email' };
  }
};
`;
      $('#netlifyCode').textContent = code;
    }

    // Boot
    document.addEventListener('DOMContentLoaded', initForm);
  </script>
</body>
</html>
