<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Law Firm Daily Intake Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f7f7fb;
      --panel: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --accent: #1f6feb; /* buttons remain blue as before */
      --danger: #dc2626;
      --border: #e5e7eb;
      --radius: 10px;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); }
    header {
      /* Orange gradient header */
      background: linear-gradient(135deg, #f97316, #fb923c);
      color: white; padding: 24px 16px;
    }
    header .inner { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; gap: 16px; flex-wrap: wrap; }
    header h1 { margin: 0; font-size: 22px; display: flex; align-items: baseline; gap: 8px; }
    header .brand { font-size: 14px; font-weight: 600; opacity: 0.95; }
    header .brand a { color: #fff; text-decoration: none; border-bottom: 1px dotted rgba(255,255,255,0.6); }
    header .brand a:hover { text-decoration: underline; }
    /* Header subtext white for visibility */
    header .muted { color: #fff; opacity: 0.95; }
    .container { max-width: 1200px; margin: 20px auto; padding: 0 16px 48px; display: grid; grid-template-columns: 1fr; gap: 20px; }

    section { background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
    section h2 { margin: 0 0 12px; font-size: 18px; }
    .row { display: grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 720px) {
      .row.cols-2 { grid-template-columns: 1fr 1fr; }
      .row.cols-3 { grid-template-columns: 1fr 1fr 1fr; }
      .row.cols-4 { grid-template-columns: 1fr 1fr 1fr 1fr; }
    }
    label { font-size: 13px; color: var(--muted); display: block; margin-bottom: 4px; }
    input[type="text"], input[type="email"], input[type="tel"], input[type="date"], input[type="number"], select, textarea {
      width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: #fff; color: var(--text);
    }
    textarea { min-height: 80px; resize: vertical; }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    button {
      appearance: none; border: 1px solid var(--border); background: #f3f4f6; color: #111827; padding: 10px 14px; border-radius: 8px; cursor: pointer; font-weight: 600;
    }
    button.primary { background: var(--accent); color: #fff; border-color: transparent; }
    button.danger { background: var(--danger); color: #fff; border-color: transparent; }
    /* New green button style */
    button.success { background: #16a34a; color: #fff; border-color: transparent; }
    .muted { color: var(--muted); font-size: 12px; }
    .table-wrap { overflow: auto; border: 1px solid var(--border); border-radius: 8px; }
    table { border-collapse: collapse; width: 100%; min-width: 900px; }
    th, td { padding: 10px; border-bottom: 1px solid var(--border); text-align: left; vertical-align: top; font-size: 14px; }
    th { background: #f8fafc; position: sticky; top: 0; z-index: 1; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; font-weight: 600; }
    .pill.status-new { background: #e5f0ff; color: #1f6feb; }
    .pill.status-review { background: #fff3cd; color: #92400e; }
    .pill.status-retained { background: #dcfce7; color: #166534; }
    .pill.status-declined { background: #fee2e2; color: #991b1b; }
    .pill.status-conflict { background: #ffe4e6; color: #9f1239; }
    .pill.urgency-high { background: #fee2e2; color: #b91c1c; }
    .pill.urgency-medium { background: #fff7ed; color: #b45309; }
    .pill.urgency-low { background: #ecfeff; color: #0e7490; }
    .totals { display: flex; flex-wrap: wrap; gap: 10px; margin: 8px 0; }
    .totals .card { background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 8px 10px; font-size: 13px; color: #111827; }
    .flex { display: flex; gap: 8px; align-items: center; }
    .spacer { flex: 1; }
    .right { text-align: right; }
    .soft { color: var(--muted); }
    .nowrap { white-space: nowrap; }

    /* Storage meter */
    .storage-meter {
      position: fixed;
      right: 16px;
      bottom: 16px;
      background: #111827;
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.25);
      opacity: 0.92;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <header>
    <div class="inner">
      <h1>
        Daily Intake Tracker
        <span class="brand">By <a href="https://www.findlaw.com/" target="_blank" rel="noopener noreferrer">FindLaw</a></span>
      </h1>
      <div class="muted">Simple, local-only. Download CSV at day’s end.</div>
    </div>
  </header>

  <div class="container">
    <!-- New Intake -->
    <section id="entryFormSection" aria-labelledby="entryFormTitle">
      <h2 id="entryFormTitle">New Intake</h2>
      <form id="intakeForm">
        <div class="row cols-4">
          <div>
            <label for="intakeDate">Date</label>
            <input type="date" id="intakeDate" required />
          </div>
          <div>
            <label for="clientName">Client Name</label>
            <input type="text" id="clientName" placeholder="Jane Doe" required />
          </div>
          <div>
            <label for="clientEmail">Email</label>
            <input type="email" id="clientEmail" placeholder="jane@example.com" />
          </div>
          <div>
            <label for="clientPhone">Phone</label>
            <input type="tel" id="clientPhone" placeholder="(555) 555-5555" />
          </div>
        </div>

        <div class="row cols-4">
          <div>
            <label for="practiceArea">Practice Area</label>
            <select id="practiceArea">
              <option value="">Select...</option>
              <option>Personal Injury</option>
              <option>Family Law</option>
              <option>Criminal Defense</option>
              <option>Immigration</option>
              <option>Employment</option>
              <option>Real Estate</option>
              <option>Business</option>
              <option>Estate Planning</option>
              <option>Civil Litigation</option>
              <option>Other</option>
            </select>
          </div>
          <div>
            <label for="matterType">Matter Type</label>
            <input type="text" id="matterType" placeholder="e.g., MVA, Divorce, H-1B, ..." />
          </div>
          <div>
            <label for="referralSource">Referral Source</label>
            <input type="text" id="referralSource" placeholder="Google, Referral, Walk-in, ..." />
          </div>
          <div>
            <label for="assignedAttorney">Assigned Attorney</label>
            <input type="text" id="assignedAttorney" placeholder="Attorney Name" />
          </div>
        </div>

        <div class="row cols-4">
          <div>
            <label for="status">Status</label>
            <select id="status">
              <option>New</option>
              <option>In Review</option>
              <option>Consult Scheduled</option>
              <option>Retained</option>
              <option>Declined</option>
              <option>Conflict</option>
            </select>
          </div>
          <div>
            <label for="urgency">Urgency</label>
            <select id="urgency">
              <option>Low</option>
              <option>Medium</option>
              <option>High</option>
            </select>
          </div>
          <div>
            <label for="conflictCheck">Conflict Check</label>
            <select id="conflictCheck">
              <option>Not Run</option>
              <option>No Conflict</option>
              <option>Potential Conflict</option>
              <option>Conflict</option>
            </select>
          </div>
          <div>
            <label for="feeType">Fee Type</label>
            <select id="feeType">
              <option>Unknown</option>
              <option>Hourly</option>
              <option>Contingency</option>
              <option>Flat</option>
            </select>
          </div>
        </div>

        <div class="row cols-4">
          <div>
            <label for="potentialValue">Potential Value ($)</label>
            <input type="number" id="potentialValue" min="0" step="100" placeholder="e.g., 10000" />
          </div>
          <div>
            <label for="followUpDate">Follow-up Date</label>
            <input type="date" id="followUpDate" />
          </div>
          <div>
            <label for="intakeOwner">Intake Owner</label>
            <input type="text" id="intakeOwner" placeholder="Staff handling intake" />
          </div>
          <div class="actions" style="align-items: end;">
            <button type="submit" class="primary">Add Intake</button>
            <button type="button" id="resetFormBtn">Reset</button>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="notes">Notes</label>
            <textarea id="notes" placeholder="Key facts, next steps, conflicts detail, etc."></textarea>
            <div class="muted">Keep sensitive data minimal; this is designed for internal intake tracking.</div>
          </div>
        </div>
      </form>
    </section>

    <!-- Today's Intakes + CSV download -->
    <section id="intakesSection" aria-labelledby="intakesTitle">
      <div class="flex">
        <h2 id="intakesTitle">Today's Intakes</h2>
        <span class="spacer"></span>
        <div class="flex">
          <label for="filterDate" class="muted" style="margin-right:6px;">Date</label>
          <input type="date" id="filterDate" />
          <button id="todayBtn">Today</button>
        </div>
      </div>

      <div class="totals" id="totalsBar"></div>

      <div class="actions">
        <button id="downloadCsvFilteredBtn" class="success">Download CSV (Selected Date)</button>
        <button id="downloadCsvAllBtn" class="success">Download CSV (All)</button>
        <button id="purgeBtn" class="danger" title="Remove all entries from this browser">Purge All</button>
      </div>

      <div class="table-wrap">
        <table id="intakesTable" aria-describedby="intakesTitle">
          <thead>
            <tr>
              <th class="nowrap">Date</th>
              <th>Client</th>
              <th>Contact</th>
              <th>Practice • Matter</th>
              <th>Assigned</th>
              <th>Status</th>
              <th>Urgency</th>
              <th>Conflict</th>
              <th class="right">Value</th>
              <th>Follow-up</th>
              <th>Owner</th>
              <th>Notes</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="intakesTbody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- Bottom-right storage meter -->
  <div id="storageNotice" class="storage-meter" role="status" aria-live="polite">Storage: calculating…</div>

  <script>
    // Helpers
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const store = {
      get(key, fallback) { try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; } catch { return fallback; } },
      set(key, val) { localStorage.setItem(key, JSON.stringify(val)); }
    };
    const todayStr = () => {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    };
    const fmtDate = (iso) => {
      if (!iso) return '';
      const [y,m,d] = iso.split('-').map(n => parseInt(n,10));
      const dt = new Date(y, (m-1), d);
      return dt.toLocaleDateString(undefined, { year:'numeric', month:'short', day:'numeric' });
    };
    const csvEscape = (s='') => `"${String(s).replace(/"/g, '""')}"`;
    const escapeHtml = (s='') => String(s)
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
      .replaceAll('"','&quot;').replaceAll("'","&#39;");

    // Storage meter utilities (conservative ~5MB quota)
    const QUOTA_BYTES = 5 * 1024 * 1024;
    function getStorageBytes() {
      let total = 0;
      const te = new TextEncoder();
      for (let i = 0; i < localStorage.length; i++) {
        const k = localStorage.key(i);
        const v = localStorage.getItem(k);
        if (k) total += te.encode(k).length;
        if (v) total += te.encode(v).length;
      }
      return total;
    }
    function formatMB(bytes) { return (bytes / (1024 * 1024)).toFixed(2); }
    let storageWarned = false;
    function updateStorageNotice() {
      const used = getStorageBytes();
      const pct = Math.min(100, Math.round((used / QUOTA_BYTES) * 100));
      const el = document.getElementById('storageNotice');
      if (el) el.textContent = `Storage: ${formatMB(used)} MB of ~5 MB used (${pct}%)`;
      if (pct >= 85 && !storageWarned) {
        storageWarned = true;
        if (confirm('Storage is almost full. Download all CSV now to back up your data?')) {
          if (typeof downloadCsvAll === 'function') downloadCsvAll();
        }
      }
    }

    // State
    const state = {
      entries: store.get('intakeEntries', []),
      filterDate: null,
      editingId: null
    };

    function cryptoRandom() {
      if (window.crypto?.getRandomValues) { const buf = new Uint32Array(2); crypto.getRandomValues(buf); return [...buf].map(n=>n.toString(16)).join(''); }
      return String(Math.random()).slice(2);
    }

    // Init
    document.addEventListener('DOMContentLoaded', init);
    function init() {
      // Defaults
      $('#intakeDate').value = todayStr();
      $('#filterDate').value = todayStr();
      state.filterDate = $('#filterDate').value;

      // Events
      $('#intakeForm').addEventListener('submit', onSubmitIntake);
      $('#resetFormBtn').addEventListener('click', () => { state.editingId = null; $('#intakeForm').reset(); $('#intakeDate').value = todayStr(); });

      $('#filterDate').addEventListener('change', e => { state.filterDate = e.target.value; draw(); });
      $('#todayBtn').addEventListener('click', () => { state.filterDate = todayStr(); $('#filterDate').value = state.filterDate; draw(); });

      $('#downloadCsvFilteredBtn').addEventListener('click', downloadCsvFiltered);
      $('#downloadCsvAllBtn').addEventListener('click', downloadCsvAll);
      $('#purgeBtn').addEventListener('click', purgeAll);

      draw();
      updateStorageNotice();
    }

    function persist() { store.set('intakeEntries', state.entries); updateStorageNotice(); }

    function onSubmitIntake(e) {
      e.preventDefault();
      const get = id => $(id.startsWith('#') ? id : `#${id}`).value.trim();
      const entry = {
        id: state.editingId || cryptoRandom(),
        date: $('#intakeDate').value,
        clientName: get('clientName'),
        clientEmail: get('clientEmail'),
        clientPhone: get('clientPhone'),
        practiceArea: get('practiceArea'),
        matterType: get('matterType'),
        referralSource: get('referralSource'),
        assignedAttorney: get('assignedAttorney'),
        status: $('#status').value,
        urgency: $('#urgency').value,
        conflictCheck: $('#conflictCheck').value,
        feeType: $('#feeType').value,
        potentialValue: parseFloat($('#potentialValue').value || '0'),
        followUpDate: $('#followUpDate').value,
        intakeOwner: get('intakeOwner'),
        notes: $('#notes').value.trim()
      };
      if (!entry.clientName) { alert('Client name is required'); return; }
      if (!entry.date) { alert('Date is required'); return; }

      if (state.editingId) {
        const idx = state.entries.findIndex(x => x.id === state.editingId);
        if (idx >= 0) state.entries[idx] = entry;
        state.editingId = null;
      } else {
        state.entries.push(entry);
      }
      persist();
      $('#intakeForm').reset();
      $('#intakeDate').value = todayStr();
      draw();
    }

    function editEntry(id) {
      const e = state.entries.find(x => x.id === id);
      if (!e) return;
      state.editingId = id;
      $('#intakeDate').value = e.date || todayStr();
      $('#clientName').value = e.clientName || '';
      $('#clientEmail').value = e.clientEmail || '';
      $('#clientPhone').value = e.clientPhone || '';
      $('#practiceArea').value = e.practiceArea || '';
      $('#matterType').value = e.matterType || '';
      $('#referralSource').value = e.referralSource || '';
      $('#assignedAttorney').value = e.assignedAttorney || '';
      $('#status').value = e.status || 'New';
      $('#urgency').value = e.urgency || 'Low';
      $('#conflictCheck').value = e.conflictCheck || 'Not Run';
      $('#feeType').value = e.feeType || 'Unknown';
      $('#potentialValue').value = e.potentialValue || '';
      $('#followUpDate').value = e.followUpDate || '';
      $('#intakeOwner').value = e.intakeOwner || '';
      $('#notes').value = e.notes || '';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function deleteEntry(id) {
      if (!confirm('Delete this intake entry?')) return;
      state.entries = state.entries.filter(x => x.id !== id);
      persist();
      draw();
    }

    function draw() {
      const entries = state.entries.filter(e => !state.filterDate || e.date === state.filterDate);
      // Totals
      renderTotals(entries);

      // Table
      const tbody = $('#intakesTbody'); tbody.innerHTML = '';
      const sorted = entries.slice().sort((a,b) => (a.urgency === 'High' ? -1 : 1));
      sorted.forEach(e => {
        const tr = document.createElement('tr');
        const email = e.clientEmail ? `<div><a href="mailto:${escapeHtml(e.clientEmail)}">${escapeHtml(e.clientEmail)}</a></div>` : '';
        const phone = e.clientPhone ? `<div>${escapeHtml(e.clientPhone)}</div>` : '';
        tr.innerHTML = `
          <td>${fmtDate(e.date)}</td>
          <td><strong>${escapeHtml(e.clientName || '')}</strong></td>
          <td>${email}${phone}</td>
          <td><div><strong>${escapeHtml(e.practiceArea || '')}</strong></div><div class="soft">${escapeHtml(e.matterType || '')}</div></td>
          <td>${escapeHtml(e.assignedAttorney || '')}</td>
          <td>${statusPill(e.status)}</td>
          <td>${urgencyPill(e.urgency)}</td>
          <td><span class="pill">${escapeHtml(e.conflictCheck || '')}</span></td>
          <td class="right">${e.potentialValue ? ('$' + e.potentialValue.toLocaleString()) : ''}</td>
          <td>${e.followUpDate ? fmtDate(e.followUpDate) : ''}</td>
          <td>${escapeHtml(e.intakeOwner || '')}</td>
          <td>${escapeHtml(e.notes || '')}</td>
          <td>
            <div class="flex">
              <button onclick="editEntry('${e.id}')">Edit</button>
              <button class="danger" onclick="deleteEntry('${e.id}')">Delete</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderTotals(entries) {
      const totals = {
        count: entries.length,
        retained: entries.filter(e => e.status === 'Retained').length,
        declined: entries.filter(e => e.status === 'Declined').length,
        conflict: entries.filter(e => e.status === 'Conflict' || e.conflictCheck === 'Conflict').length,
        consults: entries.filter(e => e.status === 'Consult Scheduled').length,
        potential: entries.reduce((sum, e) => sum + (e.potentialValue || 0), 0),
      };
      const bar = $('#totalsBar'); bar.innerHTML = '';
      const makeCard = (label, value) => {
        const div = document.createElement('div'); div.className = 'card'; div.innerHTML = `<strong>${value}</strong> ${label}`; return div;
      };
      bar.appendChild(makeCard('Total', totals.count));
      bar.appendChild(makeCard('Retained', totals.retained));
      bar.appendChild(makeCard('Consults', totals.consults));
      bar.appendChild(makeCard('Declined', totals.declined));
      bar.appendChild(makeCard('Conflicts', totals.conflict));
      bar.appendChild(makeCard('Potential $', '$' + totals.potential.toLocaleString()));
    }

    function statusPill(status='New') {
      const map = { 'New':'status-new','In Review':'status-review','Consult Scheduled':'status-review','Retained':'status-retained','Declined':'status-declined','Conflict':'status-conflict' };
      const cls = map[status] || 'status-new';
      return `<span class="pill ${cls}">${escapeHtml(status)}</span>`;
    }
    function urgencyPill(u='Low') {
      const map = { 'High':'urgency-high', 'Medium':'urgency-medium', 'Low':'urgency-low' };
      return `<span class="pill ${map[u] || 'urgency-low'}">${escapeHtml(u)}</span>`;
    }

    function downloadCsvFiltered() {
      const date = state.filterDate || todayStr();
      const filtered = state.entries.filter(e => e.date === date);
      downloadCsvFromEntries(filtered, `intakes-${date}.csv`);
    }
    function downloadCsvAll() {
      downloadCsvFromEntries(state.entries, `intakes-all-${Date.now()}.csv`);
    }
    function downloadCsvFromEntries(list, filename) {
      const cols = ['date','clientName','clientEmail','clientPhone','practiceArea','matterType','referralSource','assignedAttorney','status','urgency','conflictCheck','feeType','potentialValue','followUpDate','intakeOwner','notes'];
      const header = cols.map(csvEscape).join(',') + '\n';
      const rows = list.map(e => cols.map(k => csvEscape(e[k] ?? '')).join(',')).join('\n');
      const blob = new Blob([header + rows], { type: 'text/csv' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click(); URL.revokeObjectURL(a.href);
    }

    function purgeAll() {
      if (!confirm('This will delete ALL entries stored locally on this browser. Continue?')) return;
      state.entries = [];
      persist(); draw();
    }

    // expose edit/delete for inline handlers
    window.editEntry = editEntry;
    window.deleteEntry = deleteEntry;
  </script>
</body>
</html>
